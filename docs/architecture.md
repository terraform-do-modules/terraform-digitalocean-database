# terraform-digitalocean-database — Architecture

## Overview

This module provisions and manages DigitalOcean Managed Database clusters using the `digitalocean_database_cluster` resource. It supports four database engines, optional read replicas, connection pooling, firewall rules, and named databases and users — all within a single module invocation.

---

## Supported Engines

| Engine keyword | Database                  | Notes                                              |
|----------------|---------------------------|----------------------------------------------------|
| `pg`           | PostgreSQL                | Supports versions 14, 15, 16                       |
| `mysql`        | MySQL                     | Supports version 8; configurable SQL modes         |
| `redis`        | Redis                     | Supports eviction policies; no replica support     |
| `mongodb`      | MongoDB                   | Supports versions 6, 7                             |

Set the engine with the `cluster_engine` variable and the major version with `cluster_version`.

---

## Cluster Sizing and Node Count

`cluster_size` accepts any DigitalOcean database Droplet slug. Common values:

- `db-s-1vcpu-1gb` — development/testing
- `db-s-2vcpu-4gb` — light production
- `db-s-4vcpu-8gb` — medium production
- `db-s-6vcpu-16gb` — heavy workloads

`cluster_node_count` sets the number of primary nodes. A value of `1` creates a single-node cluster. A value of `3` creates a high-availability cluster with automatic failover. Redis and MongoDB support different node count options; consult the DigitalOcean documentation for the chosen engine.

`storage_size_mib` optionally overrides the default disk allocation for the chosen Droplet size. The value is expressed in mebibytes (MiB).

---

## Maintenance Windows

Pass `cluster_maintenance` as a map with two keys:

```hcl
cluster_maintenance = {
  maintenance_hour = "02:00:00"
  maintenance_day  = "saturday"
}
```

DigitalOcean uses this window to apply minor version patches and cluster maintenance operations. Choose a low-traffic period. The window is always one hour in duration.

---

## Read Replica Pattern

Set `replica_enable = true` to create a read replica of the primary cluster. The replica is provisioned in the region specified by `replica_region` (defaults to the primary region if not set). The replica size is controlled by `replica_size`.

Replicas are asynchronous. Connection details are exposed through the `replica_*` output values. When `create_firewall` is also enabled, a separate firewall resource is applied to the replica cluster using the same rule set.

Note: replica size can only be increased after creation; decreasing it is not supported by the API.

---

## Connection Pool Usage

Enable connection pooling by setting `create_pools = true` and supplying the `pools` list:

```hcl
create_pools = true
pools = [
  {
    name    = "web-pool"
    mode    = "transaction"
    size    = 10
    db_name = "mydb"
    user    = "appuser"
  }
]
```

Supported pooling modes: `transaction`, `session`, `statement`. Connection pools are only available for PostgreSQL clusters. Pool hostnames and URIs are exposed through the `connection_pool_*` outputs.

---

## Firewall Rules for Database Access

Set `create_firewall = true` and populate `firewall_rules` to restrict inbound connections to the cluster:

```hcl
create_firewall = true
firewall_rules = [
  {
    type  = "droplet"
    value = "<droplet-id>"
  },
  {
    type  = "ip_addr"
    value = "203.0.113.10"
  },
  {
    type  = "k8s"
    value = "<kubernetes-cluster-uuid>"
  },
  {
    type  = "tag"
    value = "backend"
  }
]
```

Valid `type` values: `droplet`, `k8s`, `ip_addr`, `tag`, `app`. When `replica_enable` is also `true`, the same rule set is applied to the replica firewall resource.

Without firewall rules the cluster is accessible to all resources within the associated VPC. Enabling the firewall restricts access to only the declared sources.

---

## Named Databases and Users

Provide a list of database names to create inside the cluster:

```hcl
databases = ["app", "analytics"]
```

Provide a list of user maps to create additional users:

```hcl
users = [
  { name = "appuser" },
  { name = "readonly", mysql_auth_plugin = "mysql_native_password" }
]
```

`mysql_auth_plugin` is only applicable to MySQL clusters. User passwords are generated by DigitalOcean and available in the `user_password` output (marked sensitive).

---

## VPC Placement

Pass `cluster_private_network_uuid` (the VPC ID) to place the cluster on a private network. The cluster's `private_host` endpoint is only reachable from resources within the same VPC and region. Always place production clusters inside a VPC and use `private_host` for application connections.

---

## Operational Checklist

- Pin `cluster_version` to a supported major version. DigitalOcean does not perform major version upgrades automatically.
- Set a `cluster_maintenance` window during off-peak hours.
- Enable `replica_enable` for production PostgreSQL and MySQL clusters to support read scaling and failover.
- Enable `create_firewall` and restrict access to known Droplets, tags, or IP ranges.
- Use `cluster_node_count = 3` for HA clusters in production environments.
- Store the `database_cluster_uri` and `database_cluster_default_password` outputs in a secrets manager; they are marked sensitive.
- Use connection pools (`create_pools = true`) with PostgreSQL to reduce connection overhead for high-concurrency applications.
- Set `storage_size_mib` explicitly in environments where the default Droplet size disk is insufficient.
- Verify backup retention is configured through the DigitalOcean control panel (automated daily backups are enabled by default for most engines).
- Use `backup_restore` only when restoring a cluster from a specific point-in-time backup during provisioning.
